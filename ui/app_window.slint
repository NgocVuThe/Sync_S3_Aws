import { Button, VerticalBox, LineEdit, HorizontalBox, ScrollView, ComboBox } from "std-widgets.slint";

// Shared
import { PathItem } from "shared/types.slint";
import { Theme } from "shared/colors.slint";

// Components
import { Header } from "components/header.slint";
import { AwsConfigSection } from "components/aws_config.slint";
import { FolderPickerSection } from "components/folder_picker.slint";
import { FilterConfigSection } from "components/filter_config.slint";
import { ProgressStatus } from "components/progress_bar.slint";

// Dialogs
import { BucketManagerDialog } from "dialogs/bucket_manager.slint";
import { RegionManagerDialog } from "dialogs/region_manager.slint";
import { ConfirmDeleteDialog } from "dialogs/confirm_delete.slint";

export { PathItem }

export component AppWindow inherits Window {
    title: "RustProAI - S3 Sync Tool";
    icon: @image-url("icon_final.png");
    min-width: 500px;
    min-height: 720px;
    background: Theme.bg-primary;

    // --- Properties (accessed from Rust) ---
    in-out property <[PathItem]> local-paths: [];
    in-out property <string> access-key;
    in-out property <string> secret-key;
    in-out property <string> session-token;
    in-out property <string> region: "ap-northeast-1";
    in-out property <string> bucket-name;
    in-out property <string> status-text: "Sẵn sàng";
    in-out property <float> progress: 0.0;
    in-out property <bool> show-config: true;
    in-out property <bool> is-error: false;
    in-out property <string> test-access-error: "";
    in-out property <string> log-path: "";
    in-out property <string> s3-base-path: "";
    in-out property <bool> is-selecting-folder: false;
    in-out property <bool> is-opening-log: false;
    in-out property <bool> is-selecting-base-path: false;
    in-out property <bool> show-filter-config: false;
    in-out property <bool> enable-filtering: true;
    in-out property <string> exclude-patterns-text: "";
    in-out property <string> include-patterns-text: "";
    in-out property <string> max-file-size-text: "100";
    in-out property <string> filter-stats: "";
    
    // Bucket Management Properties
    in-out property <[string]> bucket-list: [];
    in-out property <string> new-bucket-name: "";
    in-out property <int> editing-bucket-index: -1;
    in-out property <string> bucket-manager-error: "";
    in-out property <bool> show-confirm-delete: false;
    in-out property <int> bucket-to-delete-index: -1;
    in-out property <string> bucket-to-delete-name: "";
    in-out property <bool> show-bucket-manager: false;
    in-out property <bool> show-add-input: false;

    // Region Management Properties
    in-out property <[string]> region-list: ["ap-northeast-1"];
    in-out property <string> new-region-name: "";
    in-out property <int> editing-region-index: -1;
    in-out property <string> region-manager-error: "";
    in-out property <bool> show-confirm-delete-region: false;
    in-out property <int> region-to-delete-index: -1;
    in-out property <string> region-to-delete-name: "";
    in-out property <bool> show-region-manager: false;
    in-out property <bool> show-add-region-input: false;

    // --- Callbacks ---
    callback select-folder();
    callback select-files();
    callback clear-folders();
    callback remove-folder(int);
    callback start-sync(string, string, string, string, string, [PathItem]);
    callback test-access(string, string, string, string, string);
    callback open-settings();
    callback select-log-path();
    callback open-log-folder();
    callback select-base-path();
    callback toggle-filter-config();
    callback save-filter-config();
    callback reset-filter-config();
    callback preview-filtering();

    // Bucket management callbacks
    callback add-bucket(string);
    callback update-bucket(int, string);
    callback delete-bucket(int);

    // Region management callbacks
    callback add-region(string);
    callback update-region(int, string);
    callback delete-region(int);

    // Settings Menu Popup
    settings-menu := PopupWindow {
        x: parent.width - 180px;
        y: 40px;
        width: 150px;
        height: 140px;
        Rectangle {
            background: white;
            border-radius: 4px;
            border-width: 1px;
            border-color: #abb2bf;
            VerticalBox {
                padding: 10px;
                alignment: start;
                spacing: 5px;
                Button {
                    text: "Setting Log Path";
                    clicked => {
                        settings-menu.close();
                        select-log-path();
                    }
                }
                Button {
                    text: "Manage Buckets";
                    clicked => {
                        settings-menu.close();
                        bucket-manager-error = "";
                        new-bucket-name = "";
                        editing-bucket-index = -1;
                        show-add-input = false;
                        show-bucket-manager = true;
                    }
                }
                Button {
                    text: "Manage Regions";
                    clicked => {
                        settings-menu.close();
                        region-manager-error = "";
                        new-region-name = "";
                        editing-region-index = -1;
                        show-add-region-input = false;
                        show-region-manager = true;
                    }
                }
            }
        }
    }

    // --- Main Layout ---
    VerticalBox {
        padding: 15px;
        spacing: 12px;

        Header {
            settings-clicked => { settings-menu.show(); }
        }

        AwsConfigSection {
            access-key <=> root.access-key;
            secret-key <=> root.secret-key;
            session-token <=> root.session-token;
            region <=> root.region;
            bucket-name <=> root.bucket-name;
            region-list: root.region-list;
            bucket-list: root.bucket-list;
            show-config <=> root.show-config;
            test-access-error: root.test-access-error;
            test-access(a, s, t, r, b) => { root.test-access(a, s, t, r, b); }
        }

        FolderPickerSection {
            local-paths: root.local-paths;
            is-selecting-folder: root.is-selecting-folder;
            is-selecting-base-path: root.is-selecting-base-path;
            s3-base-path: root.s3-base-path;
            access-key: root.access-key;
            secret-key: root.secret-key;
            session-token: root.session-token;
            region: root.region;
            bucket-name: root.bucket-name;
            has-log-path: root.log-path != "";
            is-opening-log: root.is-opening-log;
            
            select-folder => { root.select-folder(); }
            select-files => { root.select-files(); }
            clear-folders => { root.clear-folders(); }
            remove-folder(idx) => { root.remove-folder(idx); }
            start-sync(a, s, t, r, b, paths) => { root.start-sync(a, s, t, r, b, paths); }
            open-log-folder => { root.open-log-folder(); }
            select-base-path => { root.select-base-path(); }
        }

        FilterConfigSection {
            show-filter-config <=> root.show-filter-config;
            enable-filtering <=> root.enable-filtering;
            max-file-size-text <=> root.max-file-size-text;
            exclude-patterns-text <=> root.exclude-patterns-text;
            include-patterns-text <=> root.include-patterns-text;
            filter-stats: root.filter-stats;
            
            toggle-filter-config => { root.toggle-filter-config(); }
            preview-filtering => { root.preview-filtering(); }
            save-filter-config => { root.save-filter-config(); }
            reset-filter-config => { root.reset-filter-config(); }
        }

        ProgressStatus {
            status-text: root.status-text;
            progress: root.progress;
            is-error: root.is-error;
        }
    }

    // --- Dialogs ---
    if (show-bucket-manager) : BucketManagerDialog {
        bucket-list: root.bucket-list;
        new-name <=> root.new-bucket-name;
        editing-index <=> root.editing-bucket-index;
        error-message: root.bucket-manager-error;
        show-add-input <=> root.show-add-input;
        
        add-bucket(name) => { root.add-bucket(name); }
        update-bucket(idx, name) => { root.update-bucket(idx, name); }
        delete-clicked(idx, name) => { 
            root.bucket-to-delete-index = idx;
            root.bucket-to-delete-name = name;
            root.show-confirm-delete = true;
        }
        close => { show-bucket-manager = false; }
    }

    if (show-confirm-delete) : ConfirmDeleteDialog {
        title: "Delete Bucket?";
        message: "Confirm delete";
        item-name: root.bucket-to-delete-name;
        confirm => {
            root.delete-bucket(root.bucket-to-delete-index);
            root.show-confirm-delete = false;
        }
        cancel => { root.show-confirm-delete = false; }
    }

    if (show-region-manager) : RegionManagerDialog {
        region-list: root.region-list;
        new-name <=> root.new-region-name;
        editing-index <=> root.editing-region-index;
        error-message: root.region-manager-error;
        show-add-input <=> root.show-add-region-input;
        
        add-region(name) => { root.add-region(name); }
        update-region(idx, name) => { root.update-region(idx, name); }
        delete-clicked(idx, name) => {
            root.region-to-delete-index = idx;
            root.region-to-delete-name = name;
            root.show-confirm-delete-region = true;
        }
        close => { show-region-manager = false; }
    }

    if (show-confirm-delete-region) : ConfirmDeleteDialog {
        title: "Delete Region?";
        message: "Confirm delete";
        item-name: root.region-to-delete-name;
        confirm => {
            root.delete-region(root.region-to-delete-index);
            root.show-confirm-delete-region = false;
        }
        cancel => { root.show-confirm-delete-region = false; }
    }
}
