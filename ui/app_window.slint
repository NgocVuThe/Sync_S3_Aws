import { Button, VerticalBox, LineEdit, HorizontalBox, ScrollView, ComboBox } from "std-widgets.slint";

export struct PathItem {
    local-path: string,
    s3-path: string,
}

export component AppWindow inherits Window {
    title: "RustProAI - S3 Sync Tool";
    icon: @image-url("icon_final.png");
    min-width: 500px;
    min-height: 720px;
    background: #1a1a1a;

    in-out property <[PathItem]> local-paths: [];
    in-out property <string> access-key;
    in-out property <string> secret-key;
    in-out property <string> session-token;
    in-out property <string> region: "ap-northeast-1";
    in-out property <string> bucket-name;
    in-out property <string> status-text: "S·∫µn s√†ng";
    in-out property <float> progress: 0.0;
    in-out property <bool> show-config: true;
    in-out property <bool> is-error: false;
    in-out property <string> test-access-error: "";
    in-out property <string> log-path: "";
    in-out property <string> s3-base-path: "";
    in-out property <bool> is-selecting-folder: false;
    in-out property <bool> is-opening-log: false;
    in-out property <bool> is-selecting-base-path: false;
    in-out property <bool> show-filter-config: false;
    in-out property <bool> enable-filtering: true;
    in-out property <string> exclude-patterns-text: "";
    in-out property <string> include-patterns-text: "";
    in-out property <string> max-file-size-text: "100";
    in-out property <string> filter-stats: "";
    
    // Bucket Management Properties
    in-out property <[string]> bucket-list: [];
    in-out property <string> new-bucket-name: "";
    in-out property <int> editing-bucket-index: -1; // -1 for new, >=0 for editing
    in-out property <string> bucket-manager-error: "";
    in-out property <bool> show-confirm-delete: false;
    in-out property <int> bucket-to-delete-index: -1;
    in-out property <string> bucket-to-delete-name: "";

    settings-menu := PopupWindow {
        x: parent.width - 180px; // Position relative to window width
        y: 40px;
        width: 150px;
        height: 100px; // Reduced height as it only has 2 buttons
        Rectangle {
            background: white;
            border-radius: 4px;
            border-width: 1px;
            border-color: #abb2bf;
            VerticalBox {
                padding: 10px;
                alignment: start;
                spacing: 5px;
                Button {
                    text: "Setting Log Path";
                    clicked => {
                        settings-menu.close();
                        select-log-path();
                    }
                }
                Button {
                    text: "Manage Buckets";
                    clicked => {
                        settings-menu.close();
                        bucket-manager-error = "";
                        new-bucket-name = "";
                        editing-bucket-index = -1;
                        bucket-manager.show();
                    }
                }
            }
        }
    }

    callback select-folder();
    callback select-files();
    callback clear-folders();
    callback remove-folder(int);
    callback start-sync(string, string, string, string, string, [PathItem]);
    callback test-access(string, string, string, string, string);
    callback open-settings();
    callback select-log-path();
    callback open-log-folder();
    callback select-base-path();
    callback toggle-filter-config();
    callback save-filter-config();
    callback reset-filter-config();
    callback preview-filtering();

    // Bucket management callbacks
    callback add-bucket(string);
    callback update-bucket(int, string);
    callback delete-bucket(int);

    bucket-manager := PopupWindow {
        x: (parent.width - 450px) / 2;
        y: (parent.height - 400px) / 2;
        width: 450px;
        height: 400px;
        Rectangle {
            background: #282c34;
            border-radius: 8px;
            border-width: 1px;
            border-color: #61afef;
            
            VerticalBox {
                padding: 15px;
                spacing: 12px;
                
                HorizontalLayout {
                    Text {
                        text: "Manage S3 Buckets";
                        font-size: 18px;
                        font-weight: 700;
                        color: #61afef;
                    }
                    Rectangle { horizontal-stretch: 1; }
                    Button {
                        text: "X";
                        width: 30px;
                        clicked => { bucket-manager.close(); }
                    }
                }

                Rectangle {
                    background: #21252b;
                    border-radius: 4px;
                    height: 200px;
                    ScrollView {
                        VerticalBox {
                            padding: 5px;
                            spacing: 5px;
                            alignment: start;
                            for bucket[index] in bucket-list : Rectangle {
                                height: 40px;
                                background: #2c313a;
                                border-radius: 4px;
                                HorizontalBox {
                                    padding: 5px;
                                    Text {
                                        text: bucket;
                                        color: #abb2bf;
                                        vertical-alignment: center;
                                        horizontal-stretch: 1;
                                        overflow: elide;
                                    }
                                    Button {
                                        text: "Edit";
                                        width: 50px;
                                        clicked => {
                                            new-bucket-name = bucket;
                                            editing-bucket-index = index;
                                            bucket-manager-error = "";
                                        }
                                    }
                                    Button {
                                        text: "Delete";
                                        width: 60px;
                                        clicked => {
                                            bucket-to-delete-index = index;
                                            bucket-to-delete-name = bucket;
                                            show-confirm-delete = true;
                                            confirm-delete-dialog.show();
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                VerticalBox {
                    spacing: 5px;
                    padding: 0;
                    Text {
                        text: editing-bucket-index >= 0 ? "Edit Bucket Name:" : "Add New Bucket:";
                        color: #e5c07b;
                        font-size: 12px;
                    }
                    HorizontalBox {
                        padding: 0;
                        spacing: 10px;
                        LineEdit {
                            text <=> new-bucket-name;
                            placeholder-text: "bucket-name-here";
                            font-size: 13px;
                            accepted => {
                                if (editing-bucket-index >= 0) {
                                    update-bucket(editing-bucket-index, new-bucket-name);
                                } else {
                                    add-bucket(new-bucket-name);
                                }
                            }
                        }
                        Button {
                            text: editing-bucket-index >= 0 ? "Update" : "Add";
                            primary: true;
                            width: 80px;
                            clicked => {
                                if (editing-bucket-index >= 0) {
                                    update-bucket(editing-bucket-index, new-bucket-name);
                                } else {
                                    add-bucket(new-bucket-name);
                                }
                            }
                        }
                        if (editing-bucket-index >= 0) : Button {
                            text: "Cancel";
                            width: 70px;
                            clicked => {
                                editing-bucket-index = -1;
                                new-bucket-name = "";
                                bucket-manager-error = "";
                            }
                        }
                    }
                }

                if (bucket-manager-error != "") : Text {
                    text: bucket-manager-error;
                    color: #e06c75;
                    font-size: 12px;
                    horizontal-alignment: center;
                }
            }
        }
    }

    confirm-delete-dialog := PopupWindow {
        x: (parent.width - 350px) / 2;
        y: (parent.height - 150px) / 2;
        width: 350px;
        height: 150px;
        Rectangle {
            background: #282c34;
            border-radius: 8px;
            border-width: 1px;
            border-color: #e06c75;
            VerticalBox {
                padding: 20px;
                spacing: 15px;
                Text {
                    text: "Delete Bucket?";
                    font-size: 16px;
                    font-weight: 700;
                    color: #e06c75;
                    horizontal-alignment: center;
                }
                Text {
                    text: "Are you sure you want to delete '" + bucket-to-delete-name + "'?";
                    color: #abb2bf;
                    horizontal-alignment: center;
                    wrap: word-wrap;
                }
                HorizontalBox {
                    alignment: center;
                    spacing: 20px;
                    Button {
                        text: "Cancel";
                        width: 80px;
                        clicked => {
                            confirm-delete-dialog.close();
                            show-confirm-delete = false;
                        }
                    }
                    Button {
                        text: "Delete";
                        primary: true;
                        width: 80px;
                        clicked => {
                            delete-bucket(bucket-to-delete-index);
                            confirm-delete-dialog.close();
                            show-confirm-delete = false;
                        }
                    }
                }
            }
        }
    }

    VerticalBox {
        padding: 15px;
        spacing: 12px;

        // Header
        HorizontalLayout {
            height: 32px; // Fixed height to prevent icon clipping
            Text {
                text: "S3 Sync Tool";
                font-size: 24px;
                font-weight: 800;
                color: #61afef;
                vertical-alignment: center;
            }
            
            Rectangle { horizontal-stretch: 1; } // Spacer
            
            // Custom Setting Button
            VerticalLayout {
                alignment: center;
                Rectangle {
                    width: 28px;
                    height: 28px;
                    background: transparent;
                    clip: false; // Prevent clipping
                    setting-ta := TouchArea {
                        clicked => { settings-menu.show(); }
                        mouse-cursor: pointer;
                    }
                    Text {
                        text: "...";
                        font-size: 20px;
                        font-weight: 900;
                        color: setting-ta.has-hover ? #61afef : white;
                        animate color { duration: 150ms; }
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }

        // AWS Auth Section
        Rectangle {
            background: #282c34;
            border-radius: 8px;
            
            VerticalBox {
                padding: 12px;
                spacing: 8px;
                
                HorizontalBox {
                    Text { text: "AWS Configuration"; color: #e5c07b; font-weight: 700; vertical-alignment: center; }
                    if (!show-config) : Button {
                        text: "Ch·ªânh s·ª≠a";
                        width: 100px;
                        clicked => { show-config = true; }
                    }
                    if (show-config) : Button {
                        text: "Clear";
                        width: 60px;
                        clicked => {
                            access-key = "";
                            secret-key = "";
                            session-token = "";
                            bucket-name = "";
                        }
                    }
                }
                
                if (show-config) : VerticalBox {
                    padding: 0;
                    spacing: 8px;
                    LineEdit {
                        placeholder-text: "AWS Access Key ID";
                        text <=> access-key;
                    }
                    LineEdit {
                        placeholder-text: "AWS Secret Access Key";
                        input-type: password;
                        text <=> secret-key;
                    }
                    LineEdit {
                        placeholder-text: "AWS Session Token (Optional)";
                        text <=> session-token;
                    }
                    HorizontalBox {
                        spacing: 10px;
                        Text { text: "Region:"; color: #abb2bf; vertical-alignment: center; }
                        ComboBox {
                            model: ["ap-northeast-1"];
                            current-value <=> region;
                        }
                    }
                    HorizontalBox {
                        spacing: 10px;
                        Text { text: "Bucket:"; color: #abb2bf; vertical-alignment: center; }
                        ComboBox {
                            model: bucket-list;
                            current-value <=> bucket-name;
                        }
                    }
                    
                     Button {
                         text: "Test Access";
                         enabled: access-key != "" && secret-key != "" && bucket-name != "" && region != "";
                         clicked => {
                             test-access(access-key, secret-key, session-token, region, bucket-name);
                         }
                     }

                     Text {
                         text: test-access-error;
                         color: #e06c75;
                         horizontal-alignment: center;
                         font-size: 11px;
                     }
                }

                if (!show-config) : Text {
                    text: "C·∫•u h√¨nh ƒë√£ s·∫µn s√†ng (Bucket: " + bucket-name + ")";
                    color: #98c379;
                    font-size: 12px;
                }
            }
        }

        // Folder Selection Section
        Rectangle {
            background: #282c34;
            border-radius: 8px;
            
            VerticalBox {
                padding: 12px;
                spacing: 8px;
                HorizontalBox {
                    alignment: start;
                    spacing: 15px;
                    Text { text: "Local Folders/Files"; color: #e5c07b; font-weight: 700; vertical-alignment: center; }
                    Button {
                        text: "X√≥a h·∫øt";
                        width: 80px;
                        height: 24px;
                        clicked => { clear-folders() }
                    }
                }
                
                Rectangle {
                    background: #21252b;
                    border-radius: 4px;
                    height: Math.min(180px, Math.max(60px, local-paths.length * 42px + 10px));
                    animate height { duration: 250ms; easing: ease-in-out; }
                    ScrollView {
                        VerticalBox {
                            padding: 2px;
                            spacing: 1px;
                            for item[index] in local-paths : Rectangle {
                                background: #2c313a;
                                border-radius: 2px;
                                 HorizontalLayout {
                                    padding-left: 6px;
                                    padding-right: 8px;
                                    height: 38px;

                                    VerticalLayout {
                                        alignment: center;
                                        Text {
                                            text: "üìÅ " + item.local-path;
                                            color: #abb2bf;
                                            font-size: 10px;
                                            overflow: elide;
                                        }
                                        Text {
                                            text: "‚ûú ‚òÅÔ∏è " + item.s3-path;
                                            color: #61afef;
                                            font-size: 10px;
                                            font-weight: 700;
                                            overflow: elide;
                                        }
                                    }

                                    Rectangle { horizontal-stretch: 1; } // Fill remaining space

                                    VerticalLayout {
                                        alignment: center;
                                        Rectangle {
                                            width: 16px;
                                            height: 16px;
                                            background: remove-ta.has-hover ? #4b5263 : #3e4451;
                                            border-radius: 8px;
                                            animate background { duration: 150ms; }
                                            
                                            remove-ta := TouchArea {
                                                clicked => { remove-folder(index) }
                                                mouse-cursor: pointer;
                                            }

                                            Text {
                                                text: "X";
                                                color: remove-ta.has-hover ? #ff7070 : #e06c75;
                                                font-size: 8px;
                                                font-weight: 1000;
                                                horizontal-alignment: center;
                                                vertical-alignment: center;
                                            }
                                        }
                                    }
                                }
                            }
                            if (local-paths.length == 0) : Text {
                                text: "Ch∆∞a ch·ªçn th∆∞ m·ª•c/file n√†o...";
                                color: #5c6370;
                                font-italic: true;
                                horizontal-alignment: center;
                            }
                        }
                    }
                }

                HorizontalBox {
                    alignment: start;
                    spacing: 8px;
                     Button {
                         text: "Th√™m Folder";
                         height: 28px;
                         primary: true;
                         enabled: !is-selecting-folder;
                         clicked => { select-folder() }
                     }
                     Button {
                         text: "Th√™m File";
                         height: 28px;
                         enabled: !is-selecting-folder;
                         clicked => { select-files() }
                     }
                    Button {
                        text: "Sync Now";
                        height: 28px;
                        primary: true;
                        enabled: access-key != "" && secret-key != "" && bucket-name != "" && region != "" && local-paths.length > 0;
                        clicked => {
                            start-sync(access-key, secret-key, session-token, region, bucket-name, local-paths);
                        }
                    }
                      Button {
                          text: "Log";
                          height: 28px;
                          enabled: log-path != "" && !is-opening-log;
                          clicked => { open-log-folder(); }
                      }
                        Button {
                            text: "BasePath";
                            height: 28px;
                            enabled: !is-selecting-base-path;
                            clicked => { select-base-path(); }
                        }
                 }

                 if (is-selecting-folder) : Text {
                     text: "ƒêang t√≠nh to√°n ƒë∆∞·ªùng d·∫´n S3...";
                     color: #61afef;
                     font-size: 11px;
                     horizontal-alignment: center;
                 }

                 if (s3-base-path != "") : HorizontalLayout {
                    padding-left: 10px;
                    height: 18px;
                    
                    Text {
                        text: "üìÅ BasePath: " + s3-base-path;
                        color: #98c379;
                        font-size: 10px;
                        font-weight: 600;
                        vertical-alignment: center;
                    }
                }
            }
        }

        // Filter Configuration Section (Moved to Bottom)
        Rectangle {
            background: #282c34;
            border-radius: 8px;
            
            VerticalBox {
                padding: 12px;
                spacing: 8px;
                
                HorizontalBox {
                    Text { text: "File Filtering"; color: #e5c07b; font-weight: 700; vertical-alignment: center; }
                    Rectangle { horizontal-stretch: 1; }
                    if (!show-filter-config) : Button {
                        text: "C·∫•u h√¨nh";
                        width: 80px;
                        height: 24px;
                        clicked => { toggle-filter-config() }
                    }
                    if (show-filter-config) : Button {
                        text: "·∫®n";
                        width: 60px;
                        height: 24px;
                        clicked => { toggle-filter-config() }
                    }
                }
                
                if (show-filter-config) : VerticalBox {
                    padding: 0;
                    spacing: 8px;
                    
                    // Enable Filtering Toggle
                    HorizontalBox {
                        spacing: 10px;
                        Text { text: "B·∫≠t l·ªçc file:"; color: #abb2bf; vertical-alignment: center; }
                        Rectangle {
                            width: 34px;
                            height: 18px;
                            background: enable-filtering ? #61afef : #3e4451;
                            border-radius: 9px;
                            TouchArea {
                                clicked => { enable-filtering = !enable-filtering; }
                                mouse-cursor: pointer;
                            }
                            Rectangle {
                                x: enable-filtering ? 18px : 2px;
                                width: 14px;
                                height: 14px;
                                background: white;
                                border-radius: 7px;
                                y: 2px;
                                animate x { duration: 150ms; }
                            }
                        }
                    }
                    
                    if (enable-filtering) : VerticalBox {
                        padding: 0;
                        spacing: 8px;
                        
                        // Max File Size
                        HorizontalBox {
                            spacing: 10px;
                            Text { text: "Max size (MB):"; color: #abb2bf; vertical-alignment: center; min-width: 100px; font-size: 11px; }
                            LineEdit {
                                text <=> max-file-size-text;
                                width: 60px;
                                height: 22px;
                                placeholder-text: "100";
                            }
                        }
                        
                        // Exclude Patterns
                        VerticalBox {
                            spacing: 4px;
                            Text { text: "Exclude (ngƒÉn c√°ch b·∫±ng d·∫•u ph·∫©y):"; color: #abb2bf; font-size: 11px; }
                            Rectangle {
                                background: #21252b;
                                border-radius: 4px;
                                LineEdit {
                                    text <=> exclude-patterns-text;
                                    placeholder-text: "node_modules, *.tmp, .git";
                                    font-size: 11px;
                                    height: 24px;
                                }
                            }
                        }
                        
                        // Include Patterns
                        VerticalBox {
                            spacing: 4px;
                            Text { text: "Include (ngƒÉn c√°ch b·∫±ng d·∫•u ph·∫©y):"; color: #abb2bf; font-size: 11px; }
                            Rectangle {
                                background: #21252b;
                                border-radius: 4px;
                                LineEdit {
                                    text <=> include-patterns-text;
                                    placeholder-text: "*.html, *.css, *.js";
                                    font-size: 11px;
                                    height: 24px;
                                }
                            }
                        }
                        
                        // Action Buttons
                        HorizontalBox {
                            spacing: 8px;
                            alignment: start;
                            Button {
                                text: "Xem tr∆∞·ªõc";
                                height: 24px;
                                clicked => { preview-filtering() }
                            }
                            Button {
                                text: "L∆∞u";
                                height: 24px;
                                primary: true;
                                clicked => { save-filter-config() }
                            }
                            Button {
                                text: "Reset";
                                height: 24px;
                                clicked => { reset-filter-config() }
                            }
                        }
                        
                        // Filter Statistics
                        if (filter-stats != "") : Rectangle {
                            background: #21252b;
                            border-radius: 4px;
                            padding: 6px;
                            Text {
                                text: filter-stats;
                                color: #98c379;
                                font-size: 10px;
                            }
                        }
                    }
                }
                
                if (!show-filter-config && enable-filtering) : Text {
                    text: "L·ªçc file ƒëang b·∫≠t";
                    color: #98c379;
                    font-size: 11px;
                }
            }
        }

        // Progress & Status
        VerticalBox {
            spacing: 8px;
            Text {
                text: status-text;
                color: is-error ? #e06c75 : #98c379;
                horizontal-alignment: center;
                overflow: elide;
            }
            
            // Custom Progress Bar
            Rectangle {
                background: #21252b;
                height: 6px;
                border-radius: 3px;
                Rectangle {
                    x: 0;
                    width: parent.width * progress;
                    background: #61afef;
                    border-radius: 3px;
                    animate width { duration: 250ms; easing: ease-in-out; }
                }
            }
        }


    }
}

